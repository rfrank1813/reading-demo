<!DOCTYPE html>
<head>
  <title>Read a word</title>
  <script
  src="https://code.jquery.com/jquery-3.4.0.min.js"
  integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
  crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.2/howler.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">



  <style>

    body {
      font-family: georgia;

      background: url(/gradient.png);
    }

    h1 {
      display: block;
      text-align: center;
      margin: 100px auto;
      font-size: 300px;
      text-transform: none;
      font-family: "proxima-nova";
      color: #AAB0D8;
    }

    .word-container {
      display: block; 
      width: 100%; 
      position: fixed; 
      top: 0px; 
      bottom: 0px; 
    }

    .tracker {
      height: 60px;
      position: fixed; 
      bottom: 0; 
      width: 100%;
    }

    .tracker img {
      float: left; 
      margin-right: 5px; 
      width: 60px;
      height: 60px;
    }

    .big-correct {
      width: 300px;
      height: 300px; 
    }

    button {
      font-size: 1em;
      padding: .2em;
    }

  </style>

</head>


<BODY>

  <div class="word-container">
    <h1 id="word">
      <button onclick="ready()">Go!</button>
    </h1>
  </div>
  
  <div style="clear: both"></div>

  <div class="tracker"></div>





</BODY>




<script>

    var connection = new WebSocket('ws://'+location.hostname+':82'); 

    connection.onopen = function (e) { 
      console.log("connected "+e); 
    }; 

    connection.onerror = function (error) { 
      console.log('WebSocket Error ' + error); 
    }; 

    connection.onmessage = function (e) { 
      window.e = e; 
      console.log(e); 
      
      console.log("message received");
      let msg= e.data; 

      // Handle hints
      if(msg.includes("hint-")) {
        parts = msg.split("-");
        position = parts[1]
        doHint(position);
        return; 
      }


      // Handle everything else 
      switch(msg) {

        case 'correct':
          var sound = new Howl({
            src: ["/positive.mp3"]
          });
          sound.play();

          $('.tracker').append("<img src='/happy.png'/>")
          $("#word").hide(); 
          $("#word").html('<img class="big-correct" src="/happy.png" /> ')
          $("#word").fadeIn(); 
          break;
        case 'incorrect':
          var sound = new Howl({
            src: ["/wrong.mp3"]
          });
          sound.play();
          break;
        default:
          $("#word").hide(); 
          $("#word").html(msg);

          console.log(msg)
          window.msg = msg
          
          // Parse string to array 
          gpcs = msg.split(","); 
          console.log(gpcs);


          // Put each gpc of the word into a span 
          html = "";
          gpcs.forEach( function(gpc, i) {
            gpc = gpc.split("~")
            gr = gpc[0]
            ph = gpc[1]
            html = html + `<div style='display:inline-block' id="position${i}" phoneme="${ph}">${gr}</div>`

          })
          $("#word").html(html);

          $("#word").fadeIn(); 
      }
    }     
  </script> 

<script> 
  
  function doHint(position) {
    id = `#position${position}`

    phoneme = $(id).attr("phoneme")

    // Play the sound
    var sound = new Howl({
      src: ["/phonemes/"+phoneme+".mp3"]
    });
    sound.play();

    // Pulse the letters
    animateCSS(id, 'pulse');
  }

  function ready() {
    $("#word").html("waiting...");
  }

  // displayButtons function
  function setup() {

    // fetch the right data for the buttons
    // add a db entry for id 0 on start state
    // $.ajax({
    //   url: "/get_word",
    //   type: "GET",
    //   success: function(data) {

    //     window.data = data;

    //     if(data.length==0) {
    //       alert("No data!"); 
    //     } 

    //     $("#word").html(data.word);
    //   }
    // });

  }


  function animateCSS(element, animationName, callback) {
    console.log("element");
    console.log(element)
    const node = document.querySelector(element)
    console.log("node");
    console.log(node)
    node.classList.add('animated', animationName)

    function handleAnimationEnd() {
        node.classList.remove('animated', animationName)
        node.removeEventListener('animationend', handleAnimationEnd)

        if (typeof callback === 'function') callback()
    }

    node.addEventListener('animationend', handleAnimationEnd)
    }

  $(document).ready(function() {
    setup();
  });
</script>