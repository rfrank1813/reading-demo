<!DOCTYPE html>
<head>
  <title>Read a word</title>
  <script
  src="https://code.jquery.com/jquery-3.4.0.min.js"
  integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
  crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.2/howler.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

  <link rel="stylesheet" href="https://static.classdojo.com/fonts/proxima/proximanova-default-stack.css"/>



  <style>

    body {
      font-family: "proxima-nova";
      background: url(/gradient.png);
    }

    h1 {
      display: block;
      text-align: center;
      margin: 0 auto;
      font-size: 300px;
      text-transform: none;
      font-family: "proxima-nova";
      color: #AAB0D8;
      position: relative;
      top: -60px;
    }

    .game-wrapper {
      display: block; 
      width: 100%; 
      position: fixed; 
      top: 0px; 
      bottom: 0px; 
    }

    .gameplay-container {
      width: 80%; 
      margin: 100px auto;
      position: relative;
      height: 440px;
    }

    .progress-tracker {
      right: 0;
      height: 15px;
      background: #AAB0D8;
      width: 50%;
      position: relative;
      left: 300px;
      top: 30px;
      border-radius: 32px;
    }

    .progress-tracker-inner {
      position: absolute;
      height: 15px; 
      width: 0%; 
      background: #0ab311;
      border-radius: 32px 0 0 32px;
    }

    .streak-tracker {
      height: 60px;
      position: absolute;
      bottom: 0;
      width: 50%;
      left: 335px;
    }

    .streak-tracker-placeholder {
      position: absolute; 
      bottom: 0; 
      width: 50%;
      left: 335px; 
      height: 60px; 
    }

    .empty-circle {
      height: 54px;
      width: 54px;
      float: left;
      margin-right: 11px;
      background: #AAB0D8;
      border-radius: 60px;
      position: relative;
      z-index: -1;
      top: 3px;
      left: 2px;
    }

    .streak-tracker img {
      float: left; 
      margin-right: 5px; 
      width: 60px;
      height: 60px;
    }

    .big-correct {
      width: 300px;
      height: 300px; 
      position:relative;
      top:50px;
    }

    button {
      font-size: 1em;
      padding: .2em;
    }

    .go-button {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      width: 100%;
      font-size: 300px;
      border-radius: 16px;
      box-shadow: 1px 2px 1px #1a1a1a;
      cursor: pointer; 
    }

  </style>

</head>


<BODY>

  <div class="game-wrapper">
    <div class="progress-tracker">
      <!-- JS fills this with 1 div for each level -->
      <div class="progress-tracker-inner"></div>
    </div>

    <div class="gameplay-container">

      <button class='go-button' onclick="ready()">Go!</button>
      
      <h1 id="word">
          <!-- filled with the word by JS  -->
      </h1>

      <div class="streak-tracker">
        <!-- JS fills this with empty circles, then inserts smileys -->
      </div>

      <div class="streak-tracker-placeholder">
        <div class="empty-circle"></div>
        <div class="empty-circle"></div>
        <div class="empty-circle"></div>
        <div class="empty-circle"></div>
        <div class="empty-circle"></div>
      </div>
    </div>

  </div>

</BODY>




<script>

    var connection = new WebSocket('ws://'+location.hostname+':82'); 

    connection.onopen = function (e) { 
      console.log("connected "+e); 
    }; 

    connection.onerror = function (error) { 
      console.log('WebSocket Error ' + error); 
    }; 

    connection.onmessage = function (e) { 
      let msg= e.data; 

      // Handle hints
      if(msg.includes("hint-")) {
        parts = msg.split("-");
        position = parts[1]
        doHint(position);
        return; 
      }

      // Handle everything else 
      switch(msg) {
        case 'correct':
          playSound("/positive.mp3")
          updateStreakTracker(1);
          break;
        case 'incorrect':
          playSound("/wrong.mp3")
          updateStreakTracker(-1)
          break;
        default:

          // updateWord function pulls from here
          window.new_word = msg

          // on first word, show to user
          // all other times, wait for updateWord to be called from elsewhere 
          if( firstWord ) {
            firstWord = false
            updateWord() 
          } else {
            // do nothing
          }
      }
    }  
  </script> 

<script>



  function playSound(url) {
    var sound = new Howl({
      src: [url]
    });
    sound.play();
  }

  // Just puts the word in html. Another function displays it. 
  function updateWord() {
    
    msg = new_word; 

    // Parse string to array 
    gpcs = msg.split(","); 

    // Put each gpc of the word into a span 
    html = "";
    gpcs.forEach( function(gpc, i) {
      gpc = gpc.split("~")
      gr = gpc[0]
      ph = gpc[1]
      html = html + `<div style='display:inline-block' id="position${i}" phoneme="${ph}">${gr}</div>`

    })
    $("#word").html(html);

    animateCSS('#word', 'zoomIn');

  }


  // What happens?

  // When the FIRST new word comes in, just call the updateWord function 

  // For all subsequent words, just set a window variable 

  // Get rid of the "pause" variable 

  // When an answer is given, do all your animation. At end of animation, call updateWord 



  function updateStreakTracker(direction) {

    // Clear the word 
    $("#word").html("")

    if(direction == 1) {
      // Add a smiley 
      $('.streak-tracker').append("<img class='tracker-smiley' src='/happy.png'/>")

      animateCSS("img:last-child", "tada", function() {
      
        // If 5 smileys, clear the tracker 
        smileys = $(".streak-tracker").children().length
        if(smileys >= 5) {
          updateProgressBar(1)
        } else {
          updateWord()
        }
      })
    }

    if(direction == -1) {

      // Add a sad face 
      $('.streak-tracker').append("<img src='/dead.png'/>")

      // Wait a tick
      setTimeout(function() {

        // Clear the streak tracker
        animateCSS(".streak-tracker", "shake", function() {
          $(".streak-tracker").children().remove()

          // Update progress bar 
          updateProgressBar(-1)
        });
      }, 1000);
    }
  }


  function updateProgressBar(direction) {

    // play a sound
    if(direction > 0) {
      playSound("/fanfare.m4a")
    } else {
      // do nothing
    }
    

    // Hide the word
    $("#word").html()

    // get screen width 
    screen_width = $(".progress-tracker").width() 

    // use screen width to determine pixel width of increment 
    section_width = Math.floor( screen_width / 20 ); 

    // multiply by direction, either 1 or -1 
    increment = section_width * direction 

    // get current progress bar width 
    current_width = $(".progress-tracker-inner").width() 

    // add result to progress bar width
    new_width = increment + current_width

    // set width to 0 if calculated width is less than 0
    if (new_width < 0) {
      new_width = 0;
    }

    // Empty streak tracker
    setTimeout(function(){
      $(".streak-tracker").children().remove()

      // update progress bar width
      animateCSS(".progress-tracker", "pulse", function() {
        $(".progress-tracker-inner").width(new_width);
        setTimeout(updateWord, 500)
      })
    }, 1000)

    
    
  } 
  
  function doHint(position) {
    id = `#position${position}`

    phoneme = $(id).attr("phoneme")

    // Play the sound
    var sound = new Howl({
      src: ["/phonemes/"+phoneme+".mp3"]
    });
    sound.play();

    // Pulse the letters
    animateCSS(id, 'bounce');
  }

  function ready() {
    $(".go-button").hide()
    $("#word").html("wait...");
  }

  // displayButtons function
  function setup() {

    // fetch the right data for the buttons
    // add a db entry for id 0 on start state
    // $.ajax({
    //   url: "/get_word",
    //   type: "GET",
    //   success: function(data) {

    //     window.data = data;

    //     if(data.length==0) {
    //       alert("No data!"); 
    //     } 

    //     $("#word").html(data.word);
    //   }
    // });

  }


  function animateCSS(element, animationName, callback) {
    console.log("element");
    console.log(element)
    const node = document.querySelector(element)
    console.log("node");
    console.log(node)
    node.classList.add('animated', animationName)

    function handleAnimationEnd() {
        node.classList.remove('animated', animationName)
        node.removeEventListener('animationend', handleAnimationEnd)

        if (typeof callback === 'function') callback()
    }

    node.addEventListener('animationend', handleAnimationEnd)
    }

  $(document).ready(function() {
    setup();
    firstWord = true
  });
</script>